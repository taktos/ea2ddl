${database.allClassCopyright}package ${glPackageBaseCommonCBeanOutsidesqlExecutor};

import java.util.List;

import ${glPackageBaseCommon}.${glDBFluteConfig};
#if (!$database.isCompatibleOutsideSqlResultOldStyle())
import ${glPackageBaseCommonCBean}.${glListResultBeanName};
import ${glPackageBaseCommonCBean}.${glResultBeanBuilderName};
#end
import ${glPackageBaseCommonCBean}.${glPagingBeanInterfaceName};
import ${glPackageBaseCommonCBean}.${glPagingHandlerName};
import ${glPackageBaseCommonCBean}.${glPagingInvokerName};
import ${glPackageBaseCommonCBean}.${glPagingResultBeanName};
import ${glPackageBaseCommonCBeanOutsidesql}.${glOutsideSqlDaoName};
import ${glPackageBaseCommonCBeanOutsidesql}.${glOutsideSqlOptionName};
import ${glPackageBaseCommonJdbc}.${glStatementConfig};

/**
 * The paging executor of outsideSql.
 * @author ${database.ClassAuthor}
 */
public class ${glOutsideSqlPagingExecutorName} {

    // ===================================================================================
    //                                                                           Attribute
    //                                                                           =========
    /** The DAO of outsideSql. (NotNull) */
    protected final ${glOutsideSqlDaoName} _outsideSqlDao;

    /** The option of outsideSql. (NotNull) */
    protected final ${glOutsideSqlOptionName} _outsideSqlOption;

    /** The DB name of table. (NotNull) */
    protected final String _tableDbName;

    // ===================================================================================
    //                                                                         Constructor
    //                                                                         ===========
    public ${glOutsideSqlPagingExecutorName}(${glOutsideSqlDaoName} outsideSqlDao, ${glOutsideSqlOptionName} outsideSqlOption, String tableDbName) {
        this._outsideSqlDao = outsideSqlDao;
        this._outsideSqlOption = outsideSqlOption;
        this._tableDbName = tableDbName;
    }

    // ===================================================================================
    //                                                                              Select
    //                                                                              ======
#if (!$database.isCompatibleOutsideSqlResultOldStyle())
    public <ENTITY> ${glListResultBeanName}<ENTITY> selectList(String path, ${glPagingBeanInterfaceName} pmb, Class<ENTITY> entityType) {
        setupScrollableCursorIfNeeds();
        List<ENTITY> resultList = _outsideSqlDao.selectList(path, pmb, _outsideSqlOption, entityType);
        return new ${glResultBeanBuilderName}<ENTITY>(_tableDbName).buildListResultBean(resultList);
    }
#else
    public <ENTITY> List<ENTITY> selectList(String path, ${glPagingBeanInterfaceName} pmb, Class<ENTITY> entityType) {
        setupScrollableCursorIfNeeds();
        return _outsideSqlDao.selectList(path, pmb, _outsideSqlOption, entityType);
    }
#end

    /**
     * Select page.
     * <p>
     * The SQL should have Count and Paging. <br />
     * You can realize by pagingBean's isPaging() method on your 'SQL Comment'. For example, 'IF Comment'. <br />
     * It returns false when it executes Count. And it returns true when it executes Paging. <br />
     * <pre>
     * - - - - - - - - - - - - - - - - - - - - - - -
     * ex) Your Correct SQL {MySQL and manualPaging}
     * - - - - - - - - - - - - - - - - - - - - - - -
     * # /[*]IF pmb.isPaging()[*]/
     * # select member.MEMBER_ID
     * #      , member.MEMBER_NAME
     * #      , memberStatus.MEMBER_STATUS_NAME
     * # -- ELSE select count(*)
     * # /[*]END[*]/
     * #   from MEMBER member
     * #     /[*]IF pmb.isPaging()[*]/
     * #     left outer join MEMBER_STATUS memberStatus
     * #       on member.MEMBER_STATUS_CODE = memberStatus.MEMBER_STATUS_CODE
     * #     /[*]END[*]/
     * #  /[*]BEGIN[*]/where
     * #    /[*]IF pmb.memberId != null[*]/member.MEMBER_ID = /[*]pmb.memberId[*]/'123'/[*]END[*]/
     * #    /[*]IF pmb.memberName != null[*]/and member.MEMBER_NAME like /[*]pmb.memberName[*]/'Billy' || '%'/[*]END[*]/
     * #  /[*]END[*]/
     * #  /[*]IF pmb.isPaging()[*]/
     * #  order by member.UPDATE_DATETIME desc
     * #  /[*]END[*]/
     * #  /[*]IF pmb.isPaging()[*]/
     * #  limit /[*]$pmb.pageStartIndex[*]/80, /[*]$pmb.fetchSize[*]/20
     * #  /[*]END[*]/
     * # 
     * o [*] is easy escape to Java Doc Comment.
     * o If it's autoPaging, the line of 'limit 80, 20' is unnecessary!
     * 
     * - - - - - - - - - - - - - - - - - - - - - - - - -
     * ex) Wrong SQL {part 1}
     *     -- Line comment before ELSE comment --
     * - - - - - - - - - - - - - - - - - - - - - - - - -
     * # /[*]IF pmb.isPaging()[*]/
     * # select member.MEMBER_ID
     * #      , member.MEMBER_NAME -- The name of member...    *NG
     * #      -- The status name of member...                  *NG
     * #      , memberStatus.MEMBER_STATUS_NAME
     * # -- ELSE select count(*)
     * # /[*]END[*]/
     * # ...
     * o It's S2Dao's restriction...Sorry
     * </pre>
     * @param <ENTITY> The type of entity.
     * @param path The path of SQL that executes count and paging. (NotNull)
     * @param pagingPath The path of paging SQL. (NotNull)
     * @param pmb The bean of paging parameter. (NotNull)
     * @param entityType The type of result entity. (NotNull)
     * @return The result bean of paging. (NotNull)
     * @exception ${glPackageBaseCommonException}.${glOutsideSqlNotFoundException} When the outside-sql is not found.
     */
    public <ENTITY> ${glPagingResultBeanName}<ENTITY> selectPage(final String path
                                                       , final ${glPagingBeanInterfaceName} pmb
                                                       , final Class<ENTITY> entityType) {
        final ${glOutsideSqlOptionName} countOption = _outsideSqlOption.copyOptionWithoutPaging();
        final ${glOutsideSqlEntityExecutorName}<${glPagingBeanInterfaceName}> countExecutor = new ${glOutsideSqlEntityExecutorName}<${glPagingBeanInterfaceName}>(_outsideSqlDao, countOption);
        final ${glPagingHandlerName}<ENTITY> handler = new ${glPagingHandlerName}<ENTITY>() {
            public ${glPagingBeanInterfaceName} getPagingBean() {
                return pmb;
            }
            public int count() {
                pmb.xsetPaging(false);
                return countExecutor.selectEntityWithDeletedCheck(path, pmb, Integer.class);
            }
            public List<ENTITY> paging() {
                pmb.xsetPaging(true);
                return selectList(path, pmb, entityType);
            }
        };
        final ${glPagingInvokerName}<ENTITY> invoker = new ${glPagingInvokerName}<ENTITY>(_tableDbName);
        if (pmb.isCountLater()) {
            invoker.countLater();
        }
        return invoker.invokePaging(handler);
    }

    protected void setupScrollableCursorIfNeeds() {
        if (!_outsideSqlOption.isAutoPaging()) {
            return;
        }
        ${glStatementConfig} statementConfig = _outsideSqlOption.getStatementConfig();
        if (statementConfig != null && statementConfig.getResultSetType() != null) {
            return;
        }
        ${glStatementConfig} defaultStatementConfig = ${glDBFluteConfig}.getInstance().getDefaultStatementConfig();
        if (defaultStatementConfig != null && defaultStatementConfig.hasResultSetType()) {
            return;
        }
        if (statementConfig == null) {
            statementConfig = new ${glStatementConfig}();
            configure(statementConfig);
        }
        statementConfig.typeScrollInsensitive();
    }
	
    // ===================================================================================
    //                                                                              Option
    //                                                                              ======
    public ${glOutsideSqlPagingExecutorName} configure(${glStatementConfig} statementConfig) {
		_outsideSqlOption.setStatementConfig(statementConfig);
        return this;
    }

    public ${glOutsideSqlPagingExecutorName} dynamicBinding() {
        _outsideSqlOption.dynamicBinding();
        return this;
    }
#if ($database.isMakeDeprecated())

    /**
     * @return The executor of cursor. (NotNull)
     * @deprecated This method is no cop. This was implemented by mistake. 
     */
    public ${glOutsideSqlCursorExecutorName}<${glPagingBeanInterfaceName}> cursorHandling() {
        return new ${glOutsideSqlCursorExecutorName}<${glPagingBeanInterfaceName}>(_outsideSqlDao, _outsideSqlOption);
    }
#end
}
